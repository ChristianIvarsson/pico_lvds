#include <stdio.h>
#include <stdint.h>

#include "pico/stdlib.h"

#include "../config.h"
#include "../panel.h"
#include "lut.h"

#define PIX_B0(r, g, b, de) (bitLUT[                    (de) << 2        | ( (b)       & 2) | ( (g)       & 1) ])
#define PIX_B1(r, g, b, vs) (bitLUT[ (((b) >> 4) & 8) | (vs) << 2        | (((b) << 1) & 2) | (((r) >> 5) & 1) ])
#define PIX_B2(r, g, b, hs) (bitLUT[ (((b) >> 3) & 8) | (hs) << 2        | (((g) >> 4) & 2) | (((r) >> 4) & 1) ])
#define PIX_B3(r, g, b)     (bitLUT[ (((g) >> 4) & 8) | (((b) >> 3) & 4) | (((g) >> 3) & 2) | (((r) >> 3) & 1) ])
#define PIX_B4(r, g, b)     (bitLUT[ (((g) >> 3) & 8) | (((b) >> 2) & 4) | (((g) >> 2) & 2) | (((r) >> 2) & 1) ])
#define PIX_B5(r, g, b)     (bitLUT[ (((r) >> 4) & 8) | (((b) >> 1) & 4) | (((g) >> 1) & 2) | (((r) >> 1) & 1) ])
#define PIX_B6(r, g, b)     (bitLUT[ (((r) >> 3) & 8) | ( (b)       & 4) | ( (g)       & 2) | ( (r)       & 1) ])

uint8_t pixLUT[256 * LUTMULTI]   __attribute__((aligned(4)));

// Convert from single-ended to differential bits
static uint32_t bitLUT[] = {
    0b01010101, // 0b0000  (0)
    0b01010110, // 0b0001  (1)
    0b01011001, // 0b0010  (2)
    0b01011010, // 0b0011  (3)
    0b01100101, // 0b0100  (4)
    0b01100110, // 0b0101  (5)
    0b01101001, // 0b0110  (6)
    0b01101010, // 0b0111  (7)
    0b10010101, // 0b1000  (8)
    0b10010110, // 0b1001  (9)
    0b10011001, // 0b1010  (A)
    0b10011010, // 0b1011  (B)
    0b10100101, // 0b1100  (C)
    0b10100110, // 0b1101  (D)
    0b10101001, // 0b1110  (E)
    0b10101010  // 0b1111  (F)
};

// from dosbox project
const uint8_t defaultPalette[256 * 3] = {
    0x00, 0x00, 0x00, 0x00, 0x00, 0x2a, 0x00, 0x2a, 0x00, 0x00, 0x2a, 0x2a, 0x2a, 0x00, 0x00, 0x2a, 0x00, 0x2a, 0x2a, 0x15, 0x00, 0x2a, 0x2a, 0x2a,
    0x15, 0x15, 0x15, 0x15, 0x15, 0x3f, 0x15, 0x3f, 0x15, 0x15, 0x3f, 0x3f, 0x3f, 0x15, 0x15, 0x3f, 0x15, 0x3f, 0x3f, 0x3f, 0x15, 0x3f, 0x3f, 0x3f,
    0x00, 0x00, 0x00, 0x05, 0x05, 0x05, 0x08, 0x08, 0x08, 0x0b, 0x0b, 0x0b, 0x0e, 0x0e, 0x0e, 0x11, 0x11, 0x11, 0x14, 0x14, 0x14, 0x18, 0x18, 0x18,
    0x1c, 0x1c, 0x1c, 0x20, 0x20, 0x20, 0x24, 0x24, 0x24, 0x28, 0x28, 0x28, 0x2d, 0x2d, 0x2d, 0x32, 0x32, 0x32, 0x38, 0x38, 0x38, 0x3f, 0x3f, 0x3f,
    0x00, 0x00, 0x3f, 0x10, 0x00, 0x3f, 0x1f, 0x00, 0x3f, 0x2f, 0x00, 0x3f, 0x3f, 0x00, 0x3f, 0x3f, 0x00, 0x2f, 0x3f, 0x00, 0x1f, 0x3f, 0x00, 0x10,
    0x3f, 0x00, 0x00, 0x3f, 0x10, 0x00, 0x3f, 0x1f, 0x00, 0x3f, 0x2f, 0x00, 0x3f, 0x3f, 0x00, 0x2f, 0x3f, 0x00, 0x1f, 0x3f, 0x00, 0x10, 0x3f, 0x00,
    0x00, 0x3f, 0x00, 0x00, 0x3f, 0x10, 0x00, 0x3f, 0x1f, 0x00, 0x3f, 0x2f, 0x00, 0x3f, 0x3f, 0x00, 0x2f, 0x3f, 0x00, 0x1f, 0x3f, 0x00, 0x10, 0x3f,
    0x1f, 0x1f, 0x3f, 0x27, 0x1f, 0x3f, 0x2f, 0x1f, 0x3f, 0x37, 0x1f, 0x3f, 0x3f, 0x1f, 0x3f, 0x3f, 0x1f, 0x37, 0x3f, 0x1f, 0x2f, 0x3f, 0x1f, 0x27,
    0x3f, 0x1f, 0x1f, 0x3f, 0x27, 0x1f, 0x3f, 0x2f, 0x1f, 0x3f, 0x37, 0x1f, 0x3f, 0x3f, 0x1f, 0x37, 0x3f, 0x1f, 0x2f, 0x3f, 0x1f, 0x27, 0x3f, 0x1f,
    0x1f, 0x3f, 0x1f, 0x1f, 0x3f, 0x27, 0x1f, 0x3f, 0x2f, 0x1f, 0x3f, 0x37, 0x1f, 0x3f, 0x3f, 0x1f, 0x37, 0x3f, 0x1f, 0x2f, 0x3f, 0x1f, 0x27, 0x3f,
    0x2d, 0x2d, 0x3f, 0x31, 0x2d, 0x3f, 0x36, 0x2d, 0x3f, 0x3a, 0x2d, 0x3f, 0x3f, 0x2d, 0x3f, 0x3f, 0x2d, 0x3a, 0x3f, 0x2d, 0x36, 0x3f, 0x2d, 0x31,
    0x3f, 0x2d, 0x2d, 0x3f, 0x31, 0x2d, 0x3f, 0x36, 0x2d, 0x3f, 0x3a, 0x2d, 0x3f, 0x3f, 0x2d, 0x3a, 0x3f, 0x2d, 0x36, 0x3f, 0x2d, 0x31, 0x3f, 0x2d,
    0x2d, 0x3f, 0x2d, 0x2d, 0x3f, 0x31, 0x2d, 0x3f, 0x36, 0x2d, 0x3f, 0x3a, 0x2d, 0x3f, 0x3f, 0x2d, 0x3a, 0x3f, 0x2d, 0x36, 0x3f, 0x2d, 0x31, 0x3f,
    0x00, 0x00, 0x1c, 0x07, 0x00, 0x1c, 0x0e, 0x00, 0x1c, 0x15, 0x00, 0x1c, 0x1c, 0x00, 0x1c, 0x1c, 0x00, 0x15, 0x1c, 0x00, 0x0e, 0x1c, 0x00, 0x07,
    0x1c, 0x00, 0x00, 0x1c, 0x07, 0x00, 0x1c, 0x0e, 0x00, 0x1c, 0x15, 0x00, 0x1c, 0x1c, 0x00, 0x15, 0x1c, 0x00, 0x0e, 0x1c, 0x00, 0x07, 0x1c, 0x00,
    0x00, 0x1c, 0x00, 0x00, 0x1c, 0x07, 0x00, 0x1c, 0x0e, 0x00, 0x1c, 0x15, 0x00, 0x1c, 0x1c, 0x00, 0x15, 0x1c, 0x00, 0x0e, 0x1c, 0x00, 0x07, 0x1c,
    0x0e, 0x0e, 0x1c, 0x11, 0x0e, 0x1c, 0x15, 0x0e, 0x1c, 0x18, 0x0e, 0x1c, 0x1c, 0x0e, 0x1c, 0x1c, 0x0e, 0x18, 0x1c, 0x0e, 0x15, 0x1c, 0x0e, 0x11,
    0x1c, 0x0e, 0x0e, 0x1c, 0x11, 0x0e, 0x1c, 0x15, 0x0e, 0x1c, 0x18, 0x0e, 0x1c, 0x1c, 0x0e, 0x18, 0x1c, 0x0e, 0x15, 0x1c, 0x0e, 0x11, 0x1c, 0x0e,
    0x0e, 0x1c, 0x0e, 0x0e, 0x1c, 0x11, 0x0e, 0x1c, 0x15, 0x0e, 0x1c, 0x18, 0x0e, 0x1c, 0x1c, 0x0e, 0x18, 0x1c, 0x0e, 0x15, 0x1c, 0x0e, 0x11, 0x1c,
    0x14, 0x14, 0x1c, 0x16, 0x14, 0x1c, 0x18, 0x14, 0x1c, 0x1a, 0x14, 0x1c, 0x1c, 0x14, 0x1c, 0x1c, 0x14, 0x1a, 0x1c, 0x14, 0x18, 0x1c, 0x14, 0x16,
    0x1c, 0x14, 0x14, 0x1c, 0x16, 0x14, 0x1c, 0x18, 0x14, 0x1c, 0x1a, 0x14, 0x1c, 0x1c, 0x14, 0x1a, 0x1c, 0x14, 0x18, 0x1c, 0x14, 0x16, 0x1c, 0x14,
    0x14, 0x1c, 0x14, 0x14, 0x1c, 0x16, 0x14, 0x1c, 0x18, 0x14, 0x1c, 0x1a, 0x14, 0x1c, 0x1c, 0x14, 0x1a, 0x1c, 0x14, 0x18, 0x1c, 0x14, 0x16, 0x1c,
    0x00, 0x00, 0x10, 0x04, 0x00, 0x10, 0x08, 0x00, 0x10, 0x0c, 0x00, 0x10, 0x10, 0x00, 0x10, 0x10, 0x00, 0x0c, 0x10, 0x00, 0x08, 0x10, 0x00, 0x04,
    0x10, 0x00, 0x00, 0x10, 0x04, 0x00, 0x10, 0x08, 0x00, 0x10, 0x0c, 0x00, 0x10, 0x10, 0x00, 0x0c, 0x10, 0x00, 0x08, 0x10, 0x00, 0x04, 0x10, 0x00,
    0x00, 0x10, 0x00, 0x00, 0x10, 0x04, 0x00, 0x10, 0x08, 0x00, 0x10, 0x0c, 0x00, 0x10, 0x10, 0x00, 0x0c, 0x10, 0x00, 0x08, 0x10, 0x00, 0x04, 0x10,
    0x08, 0x08, 0x10, 0x0a, 0x08, 0x10, 0x0c, 0x08, 0x10, 0x0e, 0x08, 0x10, 0x10, 0x08, 0x10, 0x10, 0x08, 0x0e, 0x10, 0x08, 0x0c, 0x10, 0x08, 0x0a,
    0x10, 0x08, 0x08, 0x10, 0x0a, 0x08, 0x10, 0x0c, 0x08, 0x10, 0x0e, 0x08, 0x10, 0x10, 0x08, 0x0e, 0x10, 0x08, 0x0c, 0x10, 0x08, 0x0a, 0x10, 0x08,
    0x08, 0x10, 0x08, 0x08, 0x10, 0x0a, 0x08, 0x10, 0x0c, 0x08, 0x10, 0x0e, 0x08, 0x10, 0x10, 0x08, 0x0e, 0x10, 0x08, 0x0c, 0x10, 0x08, 0x0a, 0x10,
    0x0b, 0x0b, 0x10, 0x0c, 0x0b, 0x10, 0x0d, 0x0b, 0x10, 0x0f, 0x0b, 0x10, 0x10, 0x0b, 0x10, 0x10, 0x0b, 0x0f, 0x10, 0x0b, 0x0d, 0x10, 0x0b, 0x0c,
    0x10, 0x0b, 0x0b, 0x10, 0x0c, 0x0b, 0x10, 0x0d, 0x0b, 0x10, 0x0f, 0x0b, 0x10, 0x10, 0x0b, 0x0f, 0x10, 0x0b, 0x0d, 0x10, 0x0b, 0x0c, 0x10, 0x0b,
    0x0b, 0x10, 0x0b, 0x0b, 0x10, 0x0c, 0x0b, 0x10, 0x0d, 0x0b, 0x10, 0x0f, 0x0b, 0x10, 0x10, 0x0b, 0x0f, 0x10, 0x0b, 0x0d, 0x10, 0x0b, 0x0c, 0x10,
    0xff,0x1b,0xff // P!NK
};

void genPalette_3x8(const uint8_t *p)
{
    for (uint32_t i = 0; i < 256; i++)
    {
        uint8_t r = p[(i * 3) + 0];
        uint8_t g = p[(i * 3) + 1];
        uint8_t b = p[(i * 3) + 2];
        pixLUT[(i * LUTMULTI) + 0] = PIX_B0(r, g, b, 1); // DE, Data Enable, should always be set for visible pixels
        pixLUT[(i * LUTMULTI) + 1] = PIX_B1(r, g, b, 0);
        pixLUT[(i * LUTMULTI) + 2] = PIX_B2(r, g, b, 0);
        pixLUT[(i * LUTMULTI) + 3] = PIX_B3(r, g, b);
        pixLUT[(i * LUTMULTI) + 4] = PIX_B4(r, g, b);
        pixLUT[(i * LUTMULTI) + 5] = PIX_B5(r, g, b);
#warning "Investigate packing!"
        // Looks like it's offset 6...
        pixLUT[(i * LUTMULTI) + 6] = PIX_B6(r, g, b);
    }
}

// Needs tweaking.. I just picked a random order
void genPalette_32(const uint32_t *p)
{
    for (uint32_t i = 0; i < 256; i++)
    {
        uint32_t val = *p++;
        uint8_t r = (uint8_t)(val >> 16);
        uint8_t g = (uint8_t)(val >> 8);
        uint8_t b = (uint8_t)(val);
        pixLUT[(i * LUTMULTI) + 0] = PIX_B0(r, g, b, 1); // DE, Data Enable, should always be set for visible pixels
        pixLUT[(i * LUTMULTI) + 1] = PIX_B1(r, g, b, 0);
        pixLUT[(i * LUTMULTI) + 2] = PIX_B2(r, g, b, 0);
        pixLUT[(i * LUTMULTI) + 3] = PIX_B3(r, g, b);
        pixLUT[(i * LUTMULTI) + 4] = PIX_B4(r, g, b);
        pixLUT[(i * LUTMULTI) + 5] = PIX_B5(r, g, b);
        pixLUT[(i * LUTMULTI) + 6] = PIX_B6(r, g, b);
    }
}

// You only need to know one thing. It's too slow...
void __not_in_flash_func(drawLine)(const uint8_t *src, uint32_t *dst, uint32_t srcCount)
{
    // 7168 cycles / visible line  (7.0  cycles / pixel)   (28.0000 ticks for 4)  (28.444.. microsec)
    // 8400 cycles / total line    (8.2~ cycles / pixel)   (32.8125 ticks for 4)  (33.333.. microsec)

    const uint32_t *lutPtr = (uint32_t*)pixLUT;

    for (uint32_t i = 0; i < srcCount; i++)
    {
        dst[(i * 2) + 0] = lutPtr[(src[i] * 2) + 0];
        dst[(i * 2) + 1] = lutPtr[(src[i] * 2) + 1];
    }
}
