#include <stdio.h>
#include <stdint.h>

#include "pico/stdlib.h"

#include "../config.h"
#include "../panel.h"
#include "lut.h"

#define LVDS_PIX(r, g, b, de, vs, hs) \
    (                   (de)       << 30 | ((b)&0x80) << 22 | (vs)       << 28 | ((b)&0x40) << 21 | (hs)       << 26 | ((g)&0x80) << 18 | ((b)&0x20) << 19 | \
     ((g)&0x40) << 17 | ((b)&0x10) << 18 | ((r)&0x80) << 14 | ((b)&0x08) << 17 | ((r)&0x40) << 13 | ((b)&0x04) << 16                                       | \
                                           ((g)&0x02) << 12 | ((r)&0x01) << 12 | ((g)&0x04) <<  9 | ((r)&0x02) <<  9 | ((g)&0x08) <<  6 | ((r)&0x04) <<  6 | \
     ((g)&0x10) <<  3 | ((r)&0x08) <<  3 | ((g)&0x20)       | ((r)&0x10)       | ((b)&0x01) <<  3 |(((r)>>3) & 0x04) | ((b)&0x02)       | ((g)&0x01) )

//   31     30     29     28     27     26     25     24
// < -- > < de > < b7 > < vs > < b6 > < hs > < g7 > < b5 >
//   23     22     21     20     19     18     17     16
// < g6 > < b4 > < r7 > < b3 > < r6 > < b2 > < -- > < -- >
//   15     14     13     12     11     10      9      8
// < -- > < -- > < g1 > < r0 > < g2 > < r1 > < g3 > < r2 >
//    7      6      5      4      3      2     1       0
// < g4 > < r3 > < g5 > < r4 > < b0 > < r5 > < b1 > < g0 >

// RGB format
#define extR565(val)   (((((val) >> 11) & 31) * ((1<<(DEPTH_R))-1)) / 31)
#define extG565(val)   (((((val) >>  5) & 63) * ((1<<(DEPTH_G))-1)) / 63)
#define extB565(val)   (((((val) >>  0) & 31) * ((1<<(DEPTH_B))-1)) / 31)

// BGR format
// #define extR565(val)   (((((val) >>  0) & 31) * ((1<<(DEPTH_R))-1)) / 31)
// #define extG565(val)   (((((val) >>  5) & 63) * ((1<<(DEPTH_G))-1)) / 63)
// #define extB565(val)   (((((val) >> 11) & 31) * ((1<<(DEPTH_B))-1)) / 31)

// 2k
uint32_t pixLUT[256];
uint32_t lut565_even[256];
uint32_t lut565_odd[256];

uint32_t *currentLUT = pixLUT;

// from dosbox project
const uint8_t defaultPalette[256 * 3] = {
    0x00, 0x00, 0x00, 0x00, 0x00, 0x2a, 0x00, 0x2a, 0x00, 0x00, 0x2a, 0x2a, 0x2a, 0x00, 0x00, 0x2a, 0x00, 0x2a, 0x2a, 0x15, 0x00, 0x2a, 0x2a, 0x2a,
    0x15, 0x15, 0x15, 0x15, 0x15, 0x3f, 0x15, 0x3f, 0x15, 0x15, 0x3f, 0x3f, 0x3f, 0x15, 0x15, 0x3f, 0x15, 0x3f, 0x3f, 0x3f, 0x15, 0x3f, 0x3f, 0x3f,
    0x00, 0x00, 0x00, 0x05, 0x05, 0x05, 0x08, 0x08, 0x08, 0x0b, 0x0b, 0x0b, 0x0e, 0x0e, 0x0e, 0x11, 0x11, 0x11, 0x14, 0x14, 0x14, 0x18, 0x18, 0x18,
    0x1c, 0x1c, 0x1c, 0x20, 0x20, 0x20, 0x24, 0x24, 0x24, 0x28, 0x28, 0x28, 0x2d, 0x2d, 0x2d, 0x32, 0x32, 0x32, 0x38, 0x38, 0x38, 0x3f, 0x3f, 0x3f,
    0x00, 0x00, 0x3f, 0x10, 0x00, 0x3f, 0x1f, 0x00, 0x3f, 0x2f, 0x00, 0x3f, 0x3f, 0x00, 0x3f, 0x3f, 0x00, 0x2f, 0x3f, 0x00, 0x1f, 0x3f, 0x00, 0x10,
    0x3f, 0x00, 0x00, 0x3f, 0x10, 0x00, 0x3f, 0x1f, 0x00, 0x3f, 0x2f, 0x00, 0x3f, 0x3f, 0x00, 0x2f, 0x3f, 0x00, 0x1f, 0x3f, 0x00, 0x10, 0x3f, 0x00,
    0x00, 0x3f, 0x00, 0x00, 0x3f, 0x10, 0x00, 0x3f, 0x1f, 0x00, 0x3f, 0x2f, 0x00, 0x3f, 0x3f, 0x00, 0x2f, 0x3f, 0x00, 0x1f, 0x3f, 0x00, 0x10, 0x3f,
    0x1f, 0x1f, 0x3f, 0x27, 0x1f, 0x3f, 0x2f, 0x1f, 0x3f, 0x37, 0x1f, 0x3f, 0x3f, 0x1f, 0x3f, 0x3f, 0x1f, 0x37, 0x3f, 0x1f, 0x2f, 0x3f, 0x1f, 0x27,
    0x3f, 0x1f, 0x1f, 0x3f, 0x27, 0x1f, 0x3f, 0x2f, 0x1f, 0x3f, 0x37, 0x1f, 0x3f, 0x3f, 0x1f, 0x37, 0x3f, 0x1f, 0x2f, 0x3f, 0x1f, 0x27, 0x3f, 0x1f,
    0x1f, 0x3f, 0x1f, 0x1f, 0x3f, 0x27, 0x1f, 0x3f, 0x2f, 0x1f, 0x3f, 0x37, 0x1f, 0x3f, 0x3f, 0x1f, 0x37, 0x3f, 0x1f, 0x2f, 0x3f, 0x1f, 0x27, 0x3f,
    0x2d, 0x2d, 0x3f, 0x31, 0x2d, 0x3f, 0x36, 0x2d, 0x3f, 0x3a, 0x2d, 0x3f, 0x3f, 0x2d, 0x3f, 0x3f, 0x2d, 0x3a, 0x3f, 0x2d, 0x36, 0x3f, 0x2d, 0x31,
    0x3f, 0x2d, 0x2d, 0x3f, 0x31, 0x2d, 0x3f, 0x36, 0x2d, 0x3f, 0x3a, 0x2d, 0x3f, 0x3f, 0x2d, 0x3a, 0x3f, 0x2d, 0x36, 0x3f, 0x2d, 0x31, 0x3f, 0x2d,
    0x2d, 0x3f, 0x2d, 0x2d, 0x3f, 0x31, 0x2d, 0x3f, 0x36, 0x2d, 0x3f, 0x3a, 0x2d, 0x3f, 0x3f, 0x2d, 0x3a, 0x3f, 0x2d, 0x36, 0x3f, 0x2d, 0x31, 0x3f,
    0x00, 0x00, 0x1c, 0x07, 0x00, 0x1c, 0x0e, 0x00, 0x1c, 0x15, 0x00, 0x1c, 0x1c, 0x00, 0x1c, 0x1c, 0x00, 0x15, 0x1c, 0x00, 0x0e, 0x1c, 0x00, 0x07,
    0x1c, 0x00, 0x00, 0x1c, 0x07, 0x00, 0x1c, 0x0e, 0x00, 0x1c, 0x15, 0x00, 0x1c, 0x1c, 0x00, 0x15, 0x1c, 0x00, 0x0e, 0x1c, 0x00, 0x07, 0x1c, 0x00,
    0x00, 0x1c, 0x00, 0x00, 0x1c, 0x07, 0x00, 0x1c, 0x0e, 0x00, 0x1c, 0x15, 0x00, 0x1c, 0x1c, 0x00, 0x15, 0x1c, 0x00, 0x0e, 0x1c, 0x00, 0x07, 0x1c,
    0x0e, 0x0e, 0x1c, 0x11, 0x0e, 0x1c, 0x15, 0x0e, 0x1c, 0x18, 0x0e, 0x1c, 0x1c, 0x0e, 0x1c, 0x1c, 0x0e, 0x18, 0x1c, 0x0e, 0x15, 0x1c, 0x0e, 0x11,
    0x1c, 0x0e, 0x0e, 0x1c, 0x11, 0x0e, 0x1c, 0x15, 0x0e, 0x1c, 0x18, 0x0e, 0x1c, 0x1c, 0x0e, 0x18, 0x1c, 0x0e, 0x15, 0x1c, 0x0e, 0x11, 0x1c, 0x0e,
    0x0e, 0x1c, 0x0e, 0x0e, 0x1c, 0x11, 0x0e, 0x1c, 0x15, 0x0e, 0x1c, 0x18, 0x0e, 0x1c, 0x1c, 0x0e, 0x18, 0x1c, 0x0e, 0x15, 0x1c, 0x0e, 0x11, 0x1c,
    0x14, 0x14, 0x1c, 0x16, 0x14, 0x1c, 0x18, 0x14, 0x1c, 0x1a, 0x14, 0x1c, 0x1c, 0x14, 0x1c, 0x1c, 0x14, 0x1a, 0x1c, 0x14, 0x18, 0x1c, 0x14, 0x16,
    0x1c, 0x14, 0x14, 0x1c, 0x16, 0x14, 0x1c, 0x18, 0x14, 0x1c, 0x1a, 0x14, 0x1c, 0x1c, 0x14, 0x1a, 0x1c, 0x14, 0x18, 0x1c, 0x14, 0x16, 0x1c, 0x14,
    0x14, 0x1c, 0x14, 0x14, 0x1c, 0x16, 0x14, 0x1c, 0x18, 0x14, 0x1c, 0x1a, 0x14, 0x1c, 0x1c, 0x14, 0x1a, 0x1c, 0x14, 0x18, 0x1c, 0x14, 0x16, 0x1c,
    0x00, 0x00, 0x10, 0x04, 0x00, 0x10, 0x08, 0x00, 0x10, 0x0c, 0x00, 0x10, 0x10, 0x00, 0x10, 0x10, 0x00, 0x0c, 0x10, 0x00, 0x08, 0x10, 0x00, 0x04,
    0x10, 0x00, 0x00, 0x10, 0x04, 0x00, 0x10, 0x08, 0x00, 0x10, 0x0c, 0x00, 0x10, 0x10, 0x00, 0x0c, 0x10, 0x00, 0x08, 0x10, 0x00, 0x04, 0x10, 0x00,
    0x00, 0x10, 0x00, 0x00, 0x10, 0x04, 0x00, 0x10, 0x08, 0x00, 0x10, 0x0c, 0x00, 0x10, 0x10, 0x00, 0x0c, 0x10, 0x00, 0x08, 0x10, 0x00, 0x04, 0x10,
    0x08, 0x08, 0x10, 0x0a, 0x08, 0x10, 0x0c, 0x08, 0x10, 0x0e, 0x08, 0x10, 0x10, 0x08, 0x10, 0x10, 0x08, 0x0e, 0x10, 0x08, 0x0c, 0x10, 0x08, 0x0a,
    0x10, 0x08, 0x08, 0x10, 0x0a, 0x08, 0x10, 0x0c, 0x08, 0x10, 0x0e, 0x08, 0x10, 0x10, 0x08, 0x0e, 0x10, 0x08, 0x0c, 0x10, 0x08, 0x0a, 0x10, 0x08,
    0x08, 0x10, 0x08, 0x08, 0x10, 0x0a, 0x08, 0x10, 0x0c, 0x08, 0x10, 0x0e, 0x08, 0x10, 0x10, 0x08, 0x0e, 0x10, 0x08, 0x0c, 0x10, 0x08, 0x0a, 0x10,
    0x0b, 0x0b, 0x10, 0x0c, 0x0b, 0x10, 0x0d, 0x0b, 0x10, 0x0f, 0x0b, 0x10, 0x10, 0x0b, 0x10, 0x10, 0x0b, 0x0f, 0x10, 0x0b, 0x0d, 0x10, 0x0b, 0x0c,
    0x10, 0x0b, 0x0b, 0x10, 0x0c, 0x0b, 0x10, 0x0d, 0x0b, 0x10, 0x0f, 0x0b, 0x10, 0x10, 0x0b, 0x0f, 0x10, 0x0b, 0x0d, 0x10, 0x0b, 0x0c, 0x10, 0x0b,
    0x0b, 0x10, 0x0b, 0x0b, 0x10, 0x0c, 0x0b, 0x10, 0x0d, 0x0b, 0x10, 0x0f, 0x0b, 0x10, 0x10, 0x0b, 0x0f, 0x10, 0x0b, 0x0d, 0x10, 0x0b, 0x0c, 0x10,
    0xff,0x1b,0xff // P!NK
};

const uint8_t rgb332Palette[256 * 3] = {
    0x00, 0x00, 0x00, 0x00, 0x00, 0x55, 0x00, 0x00, 0xaa, 0x00, 0x00, 0xff, 0x00, 0x24, 0x00, 0x00, 0x24, 0x55, 0x00, 0x24, 0xaa, 0x00, 0x24, 0xff, 
    0x00, 0x48, 0x00, 0x00, 0x48, 0x55, 0x00, 0x48, 0xaa, 0x00, 0x48, 0xff, 0x00, 0x6d, 0x00, 0x00, 0x6d, 0x55, 0x00, 0x6d, 0xaa, 0x00, 0x6d, 0xff, 
    0x00, 0x91, 0x00, 0x00, 0x91, 0x55, 0x00, 0x91, 0xaa, 0x00, 0x91, 0xff, 0x00, 0xb6, 0x00, 0x00, 0xb6, 0x55, 0x00, 0xb6, 0xaa, 0x00, 0xb6, 0xff, 
    0x00, 0xda, 0x00, 0x00, 0xda, 0x55, 0x00, 0xda, 0xaa, 0x00, 0xda, 0xff, 0x00, 0xff, 0x00, 0x00, 0xff, 0x55, 0x00, 0xff, 0xaa, 0x00, 0xff, 0xff, 
    0x24, 0x00, 0x00, 0x24, 0x00, 0x55, 0x24, 0x00, 0xaa, 0x24, 0x00, 0xff, 0x24, 0x24, 0x00, 0x24, 0x24, 0x55, 0x24, 0x24, 0xaa, 0x24, 0x24, 0xff, 
    0x24, 0x48, 0x00, 0x24, 0x48, 0x55, 0x24, 0x48, 0xaa, 0x24, 0x48, 0xff, 0x24, 0x6d, 0x00, 0x24, 0x6d, 0x55, 0x24, 0x6d, 0xaa, 0x24, 0x6d, 0xff, 
    0x24, 0x91, 0x00, 0x24, 0x91, 0x55, 0x24, 0x91, 0xaa, 0x24, 0x91, 0xff, 0x24, 0xb6, 0x00, 0x24, 0xb6, 0x55, 0x24, 0xb6, 0xaa, 0x24, 0xb6, 0xff, 
    0x24, 0xda, 0x00, 0x24, 0xda, 0x55, 0x24, 0xda, 0xaa, 0x24, 0xda, 0xff, 0x24, 0xff, 0x00, 0x24, 0xff, 0x55, 0x24, 0xff, 0xaa, 0x24, 0xff, 0xff, 
    0x48, 0x00, 0x00, 0x48, 0x00, 0x55, 0x48, 0x00, 0xaa, 0x48, 0x00, 0xff, 0x48, 0x24, 0x00, 0x48, 0x24, 0x55, 0x48, 0x24, 0xaa, 0x48, 0x24, 0xff, 
    0x48, 0x48, 0x00, 0x48, 0x48, 0x55, 0x48, 0x48, 0xaa, 0x48, 0x48, 0xff, 0x48, 0x6d, 0x00, 0x48, 0x6d, 0x55, 0x48, 0x6d, 0xaa, 0x48, 0x6d, 0xff, 
    0x48, 0x91, 0x00, 0x48, 0x91, 0x55, 0x48, 0x91, 0xaa, 0x48, 0x91, 0xff, 0x48, 0xb6, 0x00, 0x48, 0xb6, 0x55, 0x48, 0xb6, 0xaa, 0x48, 0xb6, 0xff, 
    0x48, 0xda, 0x00, 0x48, 0xda, 0x55, 0x48, 0xda, 0xaa, 0x48, 0xda, 0xff, 0x48, 0xff, 0x00, 0x48, 0xff, 0x55, 0x48, 0xff, 0xaa, 0x48, 0xff, 0xff, 
    0x6d, 0x00, 0x00, 0x6d, 0x00, 0x55, 0x6d, 0x00, 0xaa, 0x6d, 0x00, 0xff, 0x6d, 0x24, 0x00, 0x6d, 0x24, 0x55, 0x6d, 0x24, 0xaa, 0x6d, 0x24, 0xff, 
    0x6d, 0x48, 0x00, 0x6d, 0x48, 0x55, 0x6d, 0x48, 0xaa, 0x6d, 0x48, 0xff, 0x6d, 0x6d, 0x00, 0x6d, 0x6d, 0x55, 0x6d, 0x6d, 0xaa, 0x6d, 0x6d, 0xff, 
    0x6d, 0x91, 0x00, 0x6d, 0x91, 0x55, 0x6d, 0x91, 0xaa, 0x6d, 0x91, 0xff, 0x6d, 0xb6, 0x00, 0x6d, 0xb6, 0x55, 0x6d, 0xb6, 0xaa, 0x6d, 0xb6, 0xff, 
    0x6d, 0xda, 0x00, 0x6d, 0xda, 0x55, 0x6d, 0xda, 0xaa, 0x6d, 0xda, 0xff, 0x6d, 0xff, 0x00, 0x6d, 0xff, 0x55, 0x6d, 0xff, 0xaa, 0x6d, 0xff, 0xff, 
    0x91, 0x00, 0x00, 0x91, 0x00, 0x55, 0x91, 0x00, 0xaa, 0x91, 0x00, 0xff, 0x91, 0x24, 0x00, 0x91, 0x24, 0x55, 0x91, 0x24, 0xaa, 0x91, 0x24, 0xff, 
    0x91, 0x48, 0x00, 0x91, 0x48, 0x55, 0x91, 0x48, 0xaa, 0x91, 0x48, 0xff, 0x91, 0x6d, 0x00, 0x91, 0x6d, 0x55, 0x91, 0x6d, 0xaa, 0x91, 0x6d, 0xff, 
    0x91, 0x91, 0x00, 0x91, 0x91, 0x55, 0x91, 0x91, 0xaa, 0x91, 0x91, 0xff, 0x91, 0xb6, 0x00, 0x91, 0xb6, 0x55, 0x91, 0xb6, 0xaa, 0x91, 0xb6, 0xff, 
    0x91, 0xda, 0x00, 0x91, 0xda, 0x55, 0x91, 0xda, 0xaa, 0x91, 0xda, 0xff, 0x91, 0xff, 0x00, 0x91, 0xff, 0x55, 0x91, 0xff, 0xaa, 0x91, 0xff, 0xff, 
    0xb6, 0x00, 0x00, 0xb6, 0x00, 0x55, 0xb6, 0x00, 0xaa, 0xb6, 0x00, 0xff, 0xb6, 0x24, 0x00, 0xb6, 0x24, 0x55, 0xb6, 0x24, 0xaa, 0xb6, 0x24, 0xff, 
    0xb6, 0x48, 0x00, 0xb6, 0x48, 0x55, 0xb6, 0x48, 0xaa, 0xb6, 0x48, 0xff, 0xb6, 0x6d, 0x00, 0xb6, 0x6d, 0x55, 0xb6, 0x6d, 0xaa, 0xb6, 0x6d, 0xff, 
    0xb6, 0x91, 0x00, 0xb6, 0x91, 0x55, 0xb6, 0x91, 0xaa, 0xb6, 0x91, 0xff, 0xb6, 0xb6, 0x00, 0xb6, 0xb6, 0x55, 0xb6, 0xb6, 0xaa, 0xb6, 0xb6, 0xff, 
    0xb6, 0xda, 0x00, 0xb6, 0xda, 0x55, 0xb6, 0xda, 0xaa, 0xb6, 0xda, 0xff, 0xb6, 0xff, 0x00, 0xb6, 0xff, 0x55, 0xb6, 0xff, 0xaa, 0xb6, 0xff, 0xff, 
    0xda, 0x00, 0x00, 0xda, 0x00, 0x55, 0xda, 0x00, 0xaa, 0xda, 0x00, 0xff, 0xda, 0x24, 0x00, 0xda, 0x24, 0x55, 0xda, 0x24, 0xaa, 0xda, 0x24, 0xff, 
    0xda, 0x48, 0x00, 0xda, 0x48, 0x55, 0xda, 0x48, 0xaa, 0xda, 0x48, 0xff, 0xda, 0x6d, 0x00, 0xda, 0x6d, 0x55, 0xda, 0x6d, 0xaa, 0xda, 0x6d, 0xff, 
    0xda, 0x91, 0x00, 0xda, 0x91, 0x55, 0xda, 0x91, 0xaa, 0xda, 0x91, 0xff, 0xda, 0xb6, 0x00, 0xda, 0xb6, 0x55, 0xda, 0xb6, 0xaa, 0xda, 0xb6, 0xff, 
    0xda, 0xda, 0x00, 0xda, 0xda, 0x55, 0xda, 0xda, 0xaa, 0xda, 0xda, 0xff, 0xda, 0xff, 0x00, 0xda, 0xff, 0x55, 0xda, 0xff, 0xaa, 0xda, 0xff, 0xff, 
    0xff, 0x00, 0x00, 0xff, 0x00, 0x55, 0xff, 0x00, 0xaa, 0xff, 0x00, 0xff, 0xff, 0x24, 0x00, 0xff, 0x24, 0x55, 0xff, 0x24, 0xaa, 0xff, 0x24, 0xff, 
    0xff, 0x48, 0x00, 0xff, 0x48, 0x55, 0xff, 0x48, 0xaa, 0xff, 0x48, 0xff, 0xff, 0x6d, 0x00, 0xff, 0x6d, 0x55, 0xff, 0x6d, 0xaa, 0xff, 0x6d, 0xff, 
    0xff, 0x91, 0x00, 0xff, 0x91, 0x55, 0xff, 0x91, 0xaa, 0xff, 0x91, 0xff, 0xff, 0xb6, 0x00, 0xff, 0xb6, 0x55, 0xff, 0xb6, 0xaa, 0xff, 0xb6, 0xff, 
    0xff, 0xda, 0x00, 0xff, 0xda, 0x55, 0xff, 0xda, 0xaa, 0xff, 0xda, 0xff, 0xff, 0xff, 0x00, 0xff, 0xff, 0x55, 0xff, 0xff, 0xaa, 0xff, 0xff, 0xff, 
};

void genPalette_3x8(const uint8_t *p, uint32_t *lut)
{
    if (lut == 0) lut = currentLUT;
    for (uint32_t i = 0; i < 256; i++) {
        lut[i] = LVDS_PIX(p[(i * 3) + 0], p[(i * 3) + 1], p[(i * 3) + 2], 1, 0, 0);
    }
}

// Needs tweaking.. I just picked a random order
void genPalette_32(const uint32_t *p, uint32_t *lut)
{
    if (lut == 0) lut = currentLUT;
    for (uint32_t i = 0; i < 256; i++)
    {
        uint32_t val = *p++;
        uint8_t r = (uint8_t)(val >> 16);
        uint8_t g = (uint8_t)(val >> 8);
        uint8_t b = (uint8_t)(val);
        lut[i] = LVDS_PIX(r, g, b, 1, 0 ,0);

    }
}

// You only need to know one thing. It's too slow...
void __not_in_flash_func(drawLine)(const uint8_t *src, uint32_t *dst, uint32_t srcCount)
{
    // 7168 cycles / visible line  (7.0  cycles / pixel)   (28.0000 ticks for 4)  (28.444.. microsec)
    // 8400 cycles / total line    (8.2~ cycles / pixel)   (32.8125 ticks for 4)  (33.333.. microsec)

    const uint32_t *lutPtr = (uint32_t*)pixLUT;

    for (uint32_t i = 0; i < srcCount; i++)
    {
        dst[(i * 2) + 0] = lutPtr[(src[i] * 2) + 0];
        dst[(i * 2) + 1] = lutPtr[(src[i] * 2) + 1];
    }
}

void gen565lut(void)
{
    for (uint32_t i = 0; i < 256; i++)
    {
        uint8_t r = extR565(i);
        uint8_t g = extG565(i);
        uint8_t b = extB565(i);
        lut565_even[i] = LVDS_PIX(r, g, b, 1, 0, 0);
        r = extR565((i<<8));
        g = extG565((i<<8));
        b = extB565((i<<8));
        lut565_odd[i] = LVDS_PIX(r, g, b, 1, 0, 0);
    }
}
